const hre = require("hardhat");

async function main() {
  console.log("Deploying libraries and Account...");

  const [deployer] = await hre.ethers.getSigners();
  console.log("Deploying with account:", deployer.address);

  const RECURSIVE_VERIFIER = "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9";

  // Convert to proper bytes32 format (pad to 32 bytes)
  const supportedVK = ["0x0000000000000000000000000000000000000000000000000000000000020000", "0x000000000000000000000000000000000000000000000000000000000000001b", "0x0000000000000000000000000000000000000000000000000000000000000001", "0x000000000000000000000000000000000000000000000000000000000000000b", "0x000000000000000000000000000000dbfa0eab470bd84fe385e8f8db12acbcc0", "0x0000000000000000000000000000000000085758127411b02691ab9416bb4c56", "0x000000000000000000000000000000a6469fea4421e1af2593c13dab22b52c76", "0x000000000000000000000000000000000029701805c5f61bb992bc81192e562d", "0x0000000000000000000000000000009fae31715b287b2dadad6b4e2e5e5f617e", "0x0000000000000000000000000000000000052b4c96c97a9b13112e5e4c1bb8d1", "0x0000000000000000000000000000008a2cbf4004a9f67011a08e7821ac5b2219", "0x00000000000000000000000000000000002aa8ac7997bee8edddec795de515e0", "0x00000000000000000000000000000011a897dfb5863f2ed8eb58eff8062c18bc", "0x00000000000000000000000000000000001a5c5b2a0730e9e46a81437939f35e", "0x0000000000000000000000000000003c8a57e445a1033f10c5fe9c9ab4c722cc", "0x00000000000000000000000000000000001bfe79bcf39cc39a37a7ea180b67db", "0x0000000000000000000000000000002e4cdcc15a1a8ed33b5d9dfe48e3141a3c", "0x00000000000000000000000000000000001604f5f730c1981121915d800de790", "0x0000000000000000000000000000000282c038444f3c8e6dd7fcd10a7a9935d3", "0x0000000000000000000000000000000000305d597b76e2dc1e2f43f7e46d75d5", "0x00000000000000000000000000000029e111e1736306efc0f34377a5a57a291e", "0x000000000000000000000000000000000006dabffdd7faa716bc6cd4bbcde531", "0x000000000000000000000000000000a88204e8ad19a0198dd554c155a9968b06", "0x0000000000000000000000000000000000145b738c424f6e7e454e23672383d2", "0x0000000000000000000000000000003f1d1768aa4f1f85eaaf455b7e0566f6a5", "0x000000000000000000000000000000000018e9af8d45abec701e3fe3b3940ae4", "0x000000000000000000000000000000ac303ea71fa78e80c40aa0eb323dab781a", "0x00000000000000000000000000000000002a7f28ec778c0b9cd0939f088ecadf", "0x000000000000000000000000000000d9ad8b5943ead2741efdeb311b8305c9db", "0x000000000000000000000000000000000025043141e7a515687c6d80d0853b76", "0x0000000000000000000000000000003447e05ab4400999c9704862944ef03bb3", "0x00000000000000000000000000000000000d8d5f85133d06d56249c6463ac023", "0x0000000000000000000000000000001b6aa761f6d687ebf234866fbff0c65787", "0x00000000000000000000000000000000001065a207eb5cce3eb3bf5a95e19a40", "0x000000000000000000000000000000fec61e4cc916b22ec7cc20027427e4bc5c", "0x000000000000000000000000000000000028d9810cce1ea4e359d5424193de22", "0x00000000000000000000000000000046b131628ca0082c4030492a7bf25373a2", "0x00000000000000000000000000000000002d46c1431bae0f491cc13b5889d32e", "0x00000000000000000000000000000013210a6504b5b23b0d4c2f0ede6526a597", "0x00000000000000000000000000000000000d15b3988a2fbec4a6574505133723", "0x0000000000000000000000000000001eeb480bb0c2ee73d022f532e100794234", "0x000000000000000000000000000000000001fed28fef46a40e8da4c1df41172c", "0x000000000000000000000000000000c10598670fbfff6de1885b0db27055d1eb", "0x0000000000000000000000000000000000168aedd582319d40c28747d8d0177d", "0x0000000000000000000000000000000d75d94efbeb913eb0f4467ea406a17c5b", "0x000000000000000000000000000000000010cfea0a4bd6a700e70ea60e6a5a84", "0x00000000000000000000000000000030e4dbabefabcdfaceb3dda754f6ba23d7", "0x00000000000000000000000000000000001ff3707b7fcc640100dfd4193b911a", "0x000000000000000000000000000000945213213698ec5d19fac9a00a704a1c52", "0x000000000000000000000000000000000008ef96af832683962ded91b87efdf6", "0x00000000000000000000000000000081370b9430010a2f43cf1223e6838926c7", "0x00000000000000000000000000000000001f09c758dacd551575f50b2f56e1cc", "0x0000000000000000000000000000005b064ea4a09496ae175a2f7ace643f904b", "0x0000000000000000000000000000000000296ade86514e87036f7ba19efd678e", "0x000000000000000000000000000000cc767d051cc7e6eb12de7859f48fa13f45", "0x00000000000000000000000000000000000b4eaf5e8452a54b9a0731ff84be56", "0x00000000000000000000000000000000bb4252a94d50b644667066825e530b8e", "0x000000000000000000000000000000000011e3ba50cf79b03a31dc90b2dbe9ae", "0x000000000000000000000000000000de196017c2fbbc0581366b4b9e1110a689", "0x000000000000000000000000000000000019e4e458f00adad49211d8735fc912", "0x00000000000000000000000000000012d48c5e640bcd827953d0225898e3386f", "0x00000000000000000000000000000000000827483bcb7f767ba485abcbbded29", "0x00000000000000000000000000000056697c55701b79cdf5a3618f0b5c2d9502", "0x0000000000000000000000000000000000147af8bc7e93452d040e406e349700", "0x000000000000000000000000000000ce63f013498103b787ca2e8db39edbd9f0", "0x0000000000000000000000000000000000228a7e6e3acf81b5bd35d071609696", "0x0000000000000000000000000000008233e718871f04317694d2fc30104516b3", "0x00000000000000000000000000000000001397bf082d9f6ba113083fe1b14433", "0x000000000000000000000000000000a5207a0982740ebae52e09cc997b55ae61", "0x00000000000000000000000000000000001c39523881d5b4ddd06205c26f899a", "0x000000000000000000000000000000d0a3af6d9ec036546759f31a82c6ab7c70", "0x0000000000000000000000000000000000249d68e72ee33b603e64df4ac70fc7", "0x0000000000000000000000000000003074cd7d22688bc6efa23ea8ece81f3588", "0x0000000000000000000000000000000000121c0dd878b3333f961105e1050414", "0x00000000000000000000000000000039d3f9bd16464a64e42679f41a644b524d", "0x0000000000000000000000000000000000062460e5dc9a52073b096417b05a2e", "0x00000000000000000000000000000064f7740584f5e5a762eb6d9cd780e41ab9", "0x000000000000000000000000000000000015a58a7bc90e6570abf1280c9eb7b6", "0x0000000000000000000000000000001c268e4787250f38d18823098237f322c7", "0x000000000000000000000000000000000028bfd7b48255207bab217e9f1d1c8a", "0x000000000000000000000000000000046d6239b8842109229d75566a73f8778e", "0x000000000000000000000000000000000001e40845aa9f77f995493965f2f681", "0x000000000000000000000000000000885bd9c2d58fbdf3912999d50e83efce1d", "0x00000000000000000000000000000000002dad97092d7e7713ddeafdd0168543", "0x00000000000000000000000000000042b22656d4e9d08432c4935cb9ec0e0434", "0x000000000000000000000000000000000001dea487b09676799d9b6e943eeceb", "0x00000000000000000000000000000058a35dfa512d0c34306ff1042949209581", "0x000000000000000000000000000000000020984c9d17fd6e6c71e482bed1ee1a", "0x0000000000000000000000000000002b80d6b55199d55c762fbaec636a525f3e", "0x0000000000000000000000000000000000217f0ffe90bea51c49a1b331adae9c", "0x0000000000000000000000000000000ed2d8303f6f9c83d86d5c13f3fb4e99dd", "0x000000000000000000000000000000000009c45c61155d314160b50b20e35c94", "0x0000000000000000000000000000009cf5a0abb80a3b2fe13b28fe8f315409b7", "0x0000000000000000000000000000000000188a2ffed7f8cbe84c7a0f1b018cd0", "0x00000000000000000000000000000085656153a6120eebdf3a488dccad95d00d", "0x000000000000000000000000000000000023cd626f5dde3ce81de0e7d4f74dc2", "0x000000000000000000000000000000e014214cfc1eec34001bc0e37213a3dd90", "0x00000000000000000000000000000000002e51457f90ac649be71c69813f8f70", "0x000000000000000000000000000000c4cab1a1d3479411afd12fa5603beef8ad", "0x000000000000000000000000000000000026249bcca5ce3da70630c31f07cb5c", "0x000000000000000000000000000000cf91f0cb73295831bc93869fc19cdbad99", "0x00000000000000000000000000000000001ee5d0cdde02f62e468b034f988c56", "0x000000000000000000000000000000183a142ac675e313630847be47fe912b91", "0x00000000000000000000000000000000001558e16ed49142b74e4a2085b22287", "0x0000000000000000000000000000000000000000000000000000000000000001", "0x0000000000000000000000000000000000000000000000000000000000000000", "0x0000000000000000000000000000000000000000000000000000000000000002", "0x0000000000000000000000000000000000000000000000000000000000000000", "0x000000000000000000000000000000114506a6b642eddb153b31f290348f88e6", "0x00000000000000000000000000000000000c796b80b6d50849b12dbc054775f6", "0x0000000000000000000000000000007d9a576983f47aadcf97bf3e9f113b9e41", "0x00000000000000000000000000000000001788f7aab1287d9dae87bf111bdeb6"];
  try {
    // First deploy PoseidonT3 library
    console.log("Deploying PoseidonT3 library...");
    const PoseidonT3 = await hre.ethers.deployContract("PoseidonT3");
    await PoseidonT3.waitForDeployment();
    console.log("PoseidonT3 deployed to:", PoseidonT3.target);

    // Then deploy MerkleTreeLib with PoseidonT3 dependency
    console.log("Deploying MerkleTreeLib library...");
    const MerkleTreeLibFactory = await hre.ethers.getContractFactory("MerkleTreeLib", {
      libraries: {
        PoseidonT3: PoseidonT3.target,
      },
    });
    const MerkleTreeLib = await MerkleTreeLibFactory.deploy();
    await MerkleTreeLib.waitForDeployment();
    console.log("MerkleTreeLib deployed to:", MerkleTreeLib.target);

    // Finally deploy Account with both libraries
    console.log("Deploying Account with libraries...");
    const Account = await hre.ethers.getContractFactory("Account", {
      libraries: {
        PoseidonT3: PoseidonT3.target,
        MerkleTreeLib: MerkleTreeLib.target,
      },
    });

    const privacyAccount = await Account.deploy(deployer.address, RECURSIVE_VERIFIER, supportedVK);
    await privacyAccount.waitForDeployment();

    console.log("Account deployed to:", privacyAccount.target);

    // Test basic functions
    const owner = await privacyAccount.owner();
    const currentRoot = await privacyAccount.getCurrentRoot();

    console.log("Owner:", owner);
    console.log("Initial Merkle Root:", currentRoot.toString());

    console.log("\nâœ… Deployment successful!");
    console.log("=".repeat(50));
    console.log("PoseidonT3:", PoseidonT3.target);
    console.log("MerkleTreeLib:", MerkleTreeLib.target);
    console.log("Account:", privacyAccount.target);
    console.log("=".repeat(50));

    return privacyAccount.target;

  } catch (error) {
    console.error("Deployment failed:", error);
    throw error;
  }
}

main()
  .then((address) => {
    console.log("\nAccount deployed at:", address);
    process.exit(0);
  })
  .catch((error) => {
    console.error(error);
    process.exitCode = 1;
  });